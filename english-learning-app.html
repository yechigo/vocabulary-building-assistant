<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå­¦ç¿’ã‚¢ãƒ—ãƒª - å’Œè¨³â†’è‹±æ–‡èª­ã¿ä¸Šã’</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            padding: 30px;
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
        }

        .setup-section, .control-section {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status-box {
            background: #f3f4f6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .current-text {
            font-size: 18px;
            color: #333;
            margin-bottom: 10px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .progress {
            font-size: 14px;
            color: #667eea;
            text-align: center;
            font-weight: 600;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            color: #667eea;
            font-weight: 600;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .pulse {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ è‹±èªå­¦ç¿’ã‚¢ãƒ—ãƒª</h1>

        <div id="setupSection" class="setup-section">
            <div id="fileUploadSection" class="setup-section" style="display: none;">
                <label for="csvFile">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:</label>
                <input type="file" id="csvFile" accept=".csv" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer;">
                <div class="help-text">
                    â€» ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€â†’ã€Œã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šå½¢å¼ï¼ˆ.csvï¼‰ã€ã§ä¿å­˜ã—ã¦ãã ã•ã„
                </div>
                <button class="btn-primary" onclick="loadData()">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€</button>
            </div>

            <div id="autoLoadSection" class="setup-section" style="display: none;">
                <div class="help-text" style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    âœ… Google Apps Scriptè¨­å®šæ¸ˆã¿<br>
                    ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¨è‡ªå‹•çš„ã«æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™
                </div>
                <button class="btn-primary" onclick="loadDataFromAppsScript()">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿</button>
            </div>

            <div class="settings-grid">
                <div>
                    <label for="waitTime">å¾…æ©Ÿæ™‚é–“ï¼ˆç§’ï¼‰:</label>
                    <input type="number" id="waitTime" value="5" min="1" max="30">
                </div>
                <div>
                    <label for="repeatCount">ç¹°ã‚Šè¿”ã—å›æ•°:</label>
                    <input type="number" id="repeatCount" value="1" min="1" max="10">
                </div>
            </div>

            <div class="settings-grid">
                <div style="grid-column: 1 / -1;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="shuffleMode" style="width: auto; margin-right: 8px;">
                        <span>ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é †ã§å†ç”Ÿï¼‰</span>
                    </label>
                </div>
            </div>

            <div class="settings-grid">
                <div>
                    <label for="jpColumn">å’Œè¨³ã®åˆ—:</label>
                    <input type="text" id="jpColumn" value="C" maxlength="2">
                </div>
                <div>
                    <label for="enColumn">è‹±æ–‡ã®åˆ—:</label>
                    <input type="text" id="enColumn" value="B" maxlength="2">
                </div>
            </div>

        </div>

        <div id="controlSection" class="control-section hidden">
            <div class="status-box">
                <div class="current-text" id="currentText">æº–å‚™å®Œäº†</div>
                <div class="progress" id="progress">0 / 0</div>
            </div>

            <button class="btn-primary" id="startBtn" onclick="startLearning()">å­¦ç¿’ã‚’é–‹å§‹</button>
            <button class="btn-primary hidden" id="pauseBtn" onclick="pauseLearning()">ä¸€æ™‚åœæ­¢</button>
            <button class="btn-primary hidden" id="resumeBtn" onclick="resumeLearning()">å†é–‹</button>
            <button class="btn-danger hidden" id="stopBtn" onclick="stopLearning()">åœæ­¢</button>
            <button class="btn-primary" onclick="backToSetup()">è¨­å®šã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ========================================
        // ã€é‡è¦ã€‘ã“ã“ã«Google Apps Scriptã®URLã‚’è¨­å®šã—ã¦ãã ã•ã„
        // ========================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby1nEfEygjVIx0WXTjyPeL_As5aHsua9osVCbvvhuFcFHkWlZD33kWIjLuSt8AP8FJL/exec';  // â† ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸURLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘
        // ä¾‹: 'https://script.google.com/macros/s/AKfycby.../exec'

        let learningData = [];
        let currentIndex = 0;
        let isPlaying = false;
        let speechQueue = [];
        let currentRepeat = 0;

        // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
        if (!('speechSynthesis' in window)) {
            alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èª­ã¿ä¸Šã’ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Safariã€Edgeãªã©ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Google Apps Scriptã‹ã‚‰è‡ªå‹•èª­ã¿è¾¼ã¿
        window.addEventListener('DOMContentLoaded', () => {
            if (APPS_SCRIPT_URL) {
                // Apps Script URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•èª­ã¿è¾¼ã¿
                document.getElementById('autoLoadSection').style.display = 'block';
                loadDataFromAppsScript();
            } else {
                // URLãŒæœªè¨­å®šã®å ´åˆã€æ‰‹å‹•ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                document.getElementById('fileUploadSection').style.display = 'block';
            }
        });

        // CSVãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹å…±é€šé–¢æ•°
        function processCSVData(csvText, jpCol, enCol) {
            try {
                const rows = parseCSV(csvText);

                // åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆA=0, B=1, ...ï¼‰
                const jpIndex = jpCol.charCodeAt(0) - 65;
                const enIndex = enCol.charCodeAt(0) - 65;

                // 1è¡Œç›®ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’é™¤å¤–ã—ã€ãƒ‡ãƒ¼ã‚¿è¡Œã®ã¿ã‚’å‡¦ç†
                learningData = rows
                    .slice(1) // 1è¡Œç›®ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    .filter(row => row[jpIndex] && row[enIndex]) // ä¸¡æ–¹ã®åˆ—ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹è¡Œã®ã¿
                    .map(row => ({
                        japanese: row[jpIndex].trim(),
                        english: row[enIndex].trim()
                    }));

                if (learningData.length === 0) {
                    alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ—ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
                    return;
                }

                currentIndex = 0;
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('controlSection').classList.remove('hidden');
                document.getElementById('currentText').textContent = `${learningData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
                document.getElementById('progress').textContent = `0 / ${learningData.length}`;

            } catch (error) {
                alert('ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
            }
        }

        // Google Apps Scriptã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        async function loadDataFromAppsScript() {
            if (!APPS_SCRIPT_URL) {
                alert('Google Apps Scriptã®URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\nè¨­å®šæ‰‹é †ã¯READMEãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const jpCol = document.getElementById('jpColumn').value.toUpperCase();
            const enCol = document.getElementById('enColumn').value.toUpperCase();

            try {
                document.getElementById('currentText').innerHTML = '<div class="loading pulse">æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

                const response = await fetch(APPS_SCRIPT_URL);

                if (!response.ok) {
                    throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Apps Scriptã®URLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }

                const csvText = await response.text();
                processCSVData(csvText, jpCol, enCol);

            } catch (error) {
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message + '\n\nè¨­å®šæ‰‹é †ã¯READMEãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
            }
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€ï¼ˆæ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
        async function loadData() {
            const fileInput = document.getElementById('csvFile');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const file = fileInput.files[0];
            const jpCol = document.getElementById('jpColumn').value.toUpperCase();
            const enCol = document.getElementById('enColumn').value.toUpperCase();

            try {
                document.getElementById('currentText').innerHTML = '<div class="loading pulse">èª­ã¿è¾¼ã¿ä¸­...</div>';

                const csvText = await file.text();
                processCSVData(csvText, jpCol, enCol);

            } catch (error) {
                alert(error.message);
                document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
            }
        }

        // ç°¡æ˜“CSVãƒ‘ãƒ¼ã‚µãƒ¼
        function parseCSV(text) {
            const rows = [];
            const lines = text.split('\n');

            for (let line of lines) {
                if (!line.trim()) continue;

                const row = [];
                let cell = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];

                    if (char === '"') {
                        if (inQuotes && line[i + 1] === '"') {
                            cell += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        row.push(cell);
                        cell = '';
                    } else {
                        cell += char;
                    }
                }
                row.push(cell);
                rows.push(row);
            }

            return rows;
        }

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ©Ÿèƒ½
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // å­¦ç¿’ã‚’é–‹å§‹
        function startLearning() {
            if (learningData.length === 0) return;

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ãªå ´åˆã€ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            if (document.getElementById('shuffleMode').checked) {
                learningData = shuffleArray(learningData);
            }

            isPlaying = true;
            currentIndex = 0;
            currentRepeat = 0;
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            document.getElementById('stopBtn').classList.remove('hidden');

            playNext();
        }

        // ä¸€æ™‚åœæ­¢
        function pauseLearning() {
            isPlaying = false;
            speechSynthesis.cancel();
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('resumeBtn').classList.remove('hidden');
        }

        // å†é–‹
        function resumeLearning() {
            isPlaying = true;
            document.getElementById('resumeBtn').classList.add('hidden');
            document.getElementById('pauseBtn').classList.remove('hidden');
            playNext();
        }

        // æ¬¡ã®é …ç›®ã‚’å†ç”Ÿ
        function playNext() {
            if (!isPlaying || currentIndex >= learningData.length) {
                if (isPlaying) {
                    // ç¹°ã‚Šè¿”ã—è¨­å®šã‚’ç¢ºèª
                    const repeatCount = parseInt(document.getElementById('repeatCount').value);
                    currentRepeat++;

                    if (currentRepeat < repeatCount) {
                        currentIndex = 0;
                        playNext();
                        return;
                    }

                    // å…¨ã¦å®Œäº†
                    document.getElementById('currentText').textContent = 'å­¦ç¿’å®Œäº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼';
                    stopLearning();
                }
                return;
            }

            const item = learningData[currentIndex];
            const waitTime = parseInt(document.getElementById('waitTime').value) * 1000;

            // é€²æ—ã‚’æ›´æ–°
            document.getElementById('progress').textContent =
                `${currentIndex + 1} / ${learningData.length} (${currentRepeat + 1}å‘¨ç›®)`;

            // å’Œè¨³ã‚’è¡¨ç¤ºã—ã¦èª­ã¿ä¸Šã’
            document.getElementById('currentText').textContent = item.japanese;
            speak(item.japanese, 'ja-JP', () => {
                // å¾…æ©Ÿæ™‚é–“å¾Œã«è‹±æ–‡ã‚’èª­ã¿ä¸Šã’
                setTimeout(() => {
                    if (!isPlaying) return;

                    document.getElementById('currentText').textContent = item.english;
                    speak(item.english, 'en-US', () => {
                        currentIndex++;
                        // æ¬¡ã®é …ç›®ã¸ï¼ˆå°‘ã—é–“ã‚’ç©ºã‘ã‚‹ï¼‰
                        setTimeout(() => {
                            if (isPlaying) playNext();
                        }, 1000);
                    });
                }, waitTime);
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆã‚’èª­ã¿ä¸Šã’ã‚‹
        function speak(text, lang, callback) {
            // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.9; // èª­ã¿ä¸Šã’é€Ÿåº¦ï¼ˆ0.1ã€œ10ã€1ãŒæ¨™æº–ï¼‰
            utterance.pitch = 1.0; // éŸ³ã®é«˜ã•ï¼ˆ0ã€œ2ã€1ãŒæ¨™æº–ï¼‰

            utterance.onend = callback;
            utterance.onerror = (event) => {
                console.error('Speech error:', event);
                if (callback) callback();
            };

            speechSynthesis.speak(utterance);
        }

        // å­¦ç¿’ã‚’åœæ­¢
        function stopLearning() {
            isPlaying = false;
            speechSynthesis.cancel();
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('pauseBtn').classList.add('hidden');
            document.getElementById('resumeBtn').classList.add('hidden');
            document.getElementById('stopBtn').classList.add('hidden');
            currentRepeat = 0;
            currentIndex = 0;
        }

        // è¨­å®šç”»é¢ã«æˆ»ã‚‹
        function backToSetup() {
            stopLearning();
            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('controlSection').classList.add('hidden');
            document.getElementById('currentText').textContent = 'æº–å‚™å®Œäº†';
            learningData = [];
        }
    </script>
</body>
</html>
